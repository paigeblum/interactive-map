<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Event Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <link
    rel="stylesheet"
    href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css"
  />

  <!-- Brand font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --color-primary: #E6247A;
      --color-secondary: #FCD6E0;
      --color-text: #333;
      --font-header: 'Montserrat', sans-serif;
      --font-body: sans-serif;
      --radius: 12px;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0;
      height: 100%; width: 100%;
      font-family: var(--font-body);
      color: var(--color-text);
      background: #fefefe;
    }
    .container { display: flex; height: 100%; }

    /* Sidebar */
    #sidebar {
      width: 320px;
      background: #fff;
      box-shadow: -4px 0 8px rgba(0,0,0,0.05);
      overflow-y: auto;
      padding: 20px;
    }

    /* Logo */
    #logo-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    #logo-header img {
      width: 36px;
      height: 36px;
      border-radius: 8px;
    }
    #logo-header span {
      font-family: var(--font-header);
      font-size: 1.1rem;
      color: var(--color-primary);
      font-weight: bold;
    }

    /* Tabs */
    #tabs {
      display: flex;
      margin-bottom: 12px;
    }
    .tab-button {
      flex: 1;
      padding: 8px;
      font-family: var(--font-header);
      font-size: 0.9rem;
      border: none;
      background: #f5f5f5;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      border-radius: var(--radius);
    }
    .tab-button.active {
      background: var(--color-primary);
      color: #fff;
    }

    /* Title */
    #list-title {
      margin: 0 0 16px;
      font-family: var(--font-header);
      color: var(--color-primary);
    }

    /* Cards */
    .event-card {
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      cursor: pointer;
      transition: border 0.2s, box-shadow 0.2s;
      border: 2px solid transparent;
    }
    .event-card.active {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px var(--color-secondary);
    }
    .event-card .card-content {
      padding: 12px 16px;
    }
    .event-card .title {
      margin: 0 0 8px;
      font-family: var(--font-header);
      font-size: 1rem;
    }
    .event-card .meta {
      font-size: 0.875rem;
      color: #666;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
    }
    .event-card .meta span {
      margin-right: 8px;
      display: inline-flex;
      align-items: center;
    }
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .tag {
      background: var(--color-secondary);
      color: #000;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-family: var(--font-header);
    }

    /* Map */
    #map { flex: 1; }
  </style>
</head>
<body>
  <div class="container">
    <div id="sidebar">
      <div id="logo-header">
        <img src="/logo.png" alt="Flamingo logo">
        <span>Lynkr</span>
      </div>
      <div id="tabs">
        <button class="tab-button active" data-type="your">Your Events</button>
        <button class="tab-button" data-type="upcoming">Public Events</button>
        <button class="tab-button" data-type="group">Group Events</button>
      </div>
      <h1 id="list-title">Your Events</h1>
      <div id="cards-container"></div>
    </div>
    <div id="map"></div>
  </div>

  <script>
    mapboxgl.accessToken = "pk.eyJ1IjoicGJsdW0iLCJhIjoiY205dWlxdDd4MDl5MzJqb2I1enRhcHc0MSJ9._1rANaYTIUxYvHEMkakc4w";
    const userGroups = ['Music Lovers','Class of 2026'];

    const map = new mapboxgl.Map({
      container: 'map',
      style:     'mapbox://styles/mapbox/streets-v11',
      center:    [-74.0060,40.7128],
      zoom:      12
    });

    let allEvents = [];
    let userMarker = null;

    map.on('load', () => {
      fetch('/api/events')
        .then(r => { if (!r.ok) throw new Error(r.statusText); return r.json(); })
        .then(events => {
          allEvents = events;
          allEvents.forEach(evt => {
            const popup = new mapboxgl.Popup({offset:25})
              .setHTML(`
                <div style="font-family: 'Montserrat', sans-serif; max-width: 200px;">
                  <strong style="color: var(--color-primary);">${evt.name}</strong><br>
                  üìÖ ${new Date(evt.date).toLocaleString()}<br>
                  üìç ${evt.address}<br>
                  <span style="background:#fcd6e0;padding:2px 6px;border-radius:6px;font-size:12px;">${evt.group}</span>
                </div>
              `);
            new mapboxgl.Marker({color:'var(--color-primary)'})
              .setLngLat([evt.lon,evt.lat])
              .setPopup(popup)
              .addTo(map);
          });
          renderList('your');
        })
        .catch(err => console.error('Error loading events:',err));

      if ('geolocation' in navigator) {
        navigator.geolocation.watchPosition(
          pos => {
            const {latitude,longitude} = pos.coords;
            if (!userMarker) {
              userMarker = new mapboxgl.Marker({color:'#007AFF'})
                .setLngLat([longitude,latitude])
                .addTo(map);
            } else {
              userMarker.setLngLat([longitude,latitude]);
            }
          },
          err => console.warn('Geolocation error:',err.message),
          {enableHighAccuracy:true,maximumAge:10000,timeout:5000}
        );
      }

      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('list-title').textContent = btn.textContent;
          renderList(btn.dataset.type);
        });
      });
    });

    function renderList(type) {
      const container = document.getElementById('cards-container');
      container.innerHTML = '';

      let filtered = [];
      if (type === 'your') {
        filtered = allEvents.filter(e=>e.signedUp);
      } else if (type === 'upcoming') {
        filtered = allEvents.filter(e=>e.privacy==='Public');
      } else if (type === 'group') {
        filtered = allEvents.filter(e=> userGroups.includes(e.group) );
      }

      filtered.forEach(evt => {
        const card = document.createElement('div');
        card.className = 'event-card';
        card.innerHTML = `
          <div class="card-content">
            <p class="title">${evt.name}</p>
            <p class="meta"><span class="icon">üìÖ</span>$
              {new Date(evt.date).toLocaleDateString()} $
              {new Date(evt.date).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}
            </p>
            <p class="meta"><span class="icon">üìç</span>${evt.address}</p>
            <p class="meta"><span class="icon">üë•</span>${evt.groupGoingCount} in your group going</p>
            <div class="tags">
              <span class="tag">${evt.privacy}</span>
              <span class="tag">${evt.group}</span>
              ${evt.recurring?'<span class="tag">Recurring</span>':''}
            </div>
          </div>
        `;
        card.addEventListener('click', () => {
          map.flyTo({center:[evt.lon,evt.lat],zoom:15});
          new mapboxgl.Popup({offset:25})
            .setLngLat([evt.lon,evt.lat])
            .setHTML(`<strong>${evt.name}</strong>`)
            .addTo(map);
          document.querySelectorAll('.event-card').forEach(c=>c.classList.remove('active'));
          card.classList.add('active');
        });
        container.appendChild(card);
      });
    }
  </script>
</body>
</html>
